---
const apiBase = import.meta.env.PUBLIC_API_BASE ?? "";
---

<form id="lead-form" class="card-base p-5 md:p-6">
  <div class="grid gap-4 md:grid-cols-2">
    <div>
      <label for="name" class="mb-1 block text-sm font-medium text-slate-700">Nome e cognome</label>
      <input
        id="name"
        name="name"
        required
        class="w-full rounded-xl border border-[color:var(--border)] px-3 py-2.5 outline-none ring-0 focus:border-slate-400"
        placeholder="Mario Rossi"
      />
    </div>
    <div>
      <label for="company" class="mb-1 block text-sm font-medium text-slate-700">Azienda / Condominio</label>
      <input
        id="company"
        name="company"
        class="w-full rounded-xl border border-[color:var(--border)] px-3 py-2.5 outline-none ring-0 focus:border-slate-400"
        placeholder="Nome struttura"
      />
    </div>
    <div>
      <label for="email" class="mb-1 block text-sm font-medium text-slate-700">Email</label>
      <input
        id="email"
        type="email"
        name="email"
        required
        class="w-full rounded-xl border border-[color:var(--border)] px-3 py-2.5 outline-none ring-0 focus:border-slate-400"
        placeholder="nome@azienda.it"
      />
    </div>
    <div>
      <label for="phone" class="mb-1 block text-sm font-medium text-slate-700">Telefono</label>
      <input
        id="phone"
        name="phone"
        class="w-full rounded-xl border border-[color:var(--border)] px-3 py-2.5 outline-none ring-0 focus:border-slate-400"
        placeholder="+39 ..."
      />
    </div>
  </div>

  <div class="mt-4">
    <label for="service" class="mb-1 block text-sm font-medium text-slate-700">Servizio richiesto</label>
    <select
      id="service"
      name="service"
      class="w-full rounded-xl border border-[color:var(--border)] px-3 py-2.5 outline-none ring-0 focus:border-slate-400"
    >
      <option>Pulizie uffici</option>
      <option>Pulizie condomìni</option>
      <option>Pulizie industriali</option>
      <option>Sanificazioni / Straordinari</option>
      <option>Altro</option>
    </select>
  </div>

  <div class="mt-4">
    <label for="message" class="mb-1 block text-sm font-medium text-slate-700">Messaggio</label>
    <textarea
      id="message"
      name="message"
      required
      rows="5"
      class="w-full rounded-xl border border-[color:var(--border)] px-3 py-2.5 outline-none ring-0 focus:border-slate-400"
      placeholder="Descrivi brevemente la richiesta, gli spazi e la città..."
    ></textarea>
  </div>

  <div class="mt-4 flex items-start gap-2">
    <input id="privacy-check" type="checkbox" required class="mt-1 h-4 w-4 rounded border-[color:var(--border)]" />
    <label for="privacy-check" class="text-sm text-slate-600">
      Ho letto l'informativa privacy e acconsento al trattamento dei dati per la gestione della richiesta.
    </label>
  </div>

  <div class="mt-5 flex flex-col gap-3 sm:flex-row sm:items-center">
    <button
      type="submit"
      class="btn btn-primary disabled:opacity-60"
    >
      Invia richiesta
    </button>
    <p id="lead-status" class="text-sm text-slate-600" aria-live="polite"></p>
  </div>

  <p class="mt-3 text-xs text-slate-500">
    Form pronto per collegamento API. Finché l'API non è attiva, la demo simula l'invio per test UI.
  </p>
</form>

<script is:inline define:vars={{ apiBase }}>
  const API_BASE = apiBase ?? "";
  const form = document.getElementById("lead-form");
  const statusEl = document.getElementById("lead-status");

  if (form && statusEl) {
    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const button = form.querySelector('button[type="submit"]');
      if (button) button.disabled = true;
      statusEl.textContent = "Invio in corso...";

      const formData = new FormData(form);

      try {
        if (API_BASE) {
          const response = await fetch(`${API_BASE}/v1/leads`, {
            method: "POST",
            headers: { Accept: "application/json" },
            body: formData,
          });

          if (!response.ok) throw new Error("API error");
        } else {
          await new Promise((resolve) => setTimeout(resolve, 700));
        }

        statusEl.textContent = "Richiesta inviata. Ti ricontattiamo al più presto.";
        form.reset();

        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({ event: "generate_lead" });
      } catch (err) {
        statusEl.textContent = "Invio non riuscito. Riprova o contattaci via WhatsApp.";
      } finally {
        if (button) button.disabled = false;
      }
    });
  }
</script>