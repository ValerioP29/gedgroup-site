---
import { site, getWhatsAppUrl } from "../data/site";
import UiIcon from "./icons/UiIcon.astro";

const links = [
  { href: "/", label: "Home" },
  { href: "/servizi", label: "Servizi" },
  { href: "/chi-siamo", label: "Chi siamo" },
  { href: "/casi-studio", label: "Casi studio" },
  { href: "/certificazioni", label: "Certificazioni" },
  { href: "/customer-care", label: "Customer care" },
  { href: "/contatti", label: "Contatti" },
];
const currentPath = Astro.url.pathname;

const isCustomerCare = currentPath.startsWith("/customer-care");

const primaryCta = isCustomerCare
  ? { href: "/contatti", label: "Nuovo preventivo", track: "click_nav_lead", icon: "clipboard" as const }
  : { href: "/contatti", label: "Richiedi preventivo", track: "click_nav_lead", icon: "clipboard" as const };

const secondaryCta = {
  href: isCustomerCare
    ? getWhatsAppUrl("Ciao GED Group, sono cliente attivo e ho bisogno di assistenza.")
    : getWhatsAppUrl(),
  label: isCustomerCare ? "WhatsApp assistenza" : "WhatsApp",
  isExternal: true,
  track: "click_whatsapp",
  className: "btn btn-whatsapp",
  icon: "whatsapp" as const,
};
---

<header id="site-header" class="site-header sticky top-0 z-40">
  <div class="site-container-wide">
    <div class="site-header-shell">
      <a href="/" class="header-brand" aria-label="Torna alla Home GED Group">
        <div class="header-brand-mark">G</div>
        <div class="min-w-0">
          <p class="header-brand-title">{site.companyName}</p>
          <p class="header-brand-subtitle">Impresa di pulizie</p>
        </div>
      </a>

      <nav class="header-nav" aria-label="Menu principale desktop">
        {links.map((link) => {
          const isCurrent = currentPath === link.href || (link.href !== "/" && currentPath.startsWith(link.href));
          return (
            <a href={link.href} aria-current={isCurrent ? "page" : undefined} class={`header-nav-link ${isCurrent ? "is-active" : ""}`}>
              <span>{link.label}</span>
            </a>
          );
        })}
      </nav>

      <div class="header-cta-row">
        <a href={`tel:${site.phoneHref}`} class="btn btn-secondary header-cta-call" data-track="click_phone">
          <UiIcon name="phone" />
          Chiama
        </a>
        <a href={primaryCta.href} class="btn btn-primary header-cta-primary" data-track={primaryCta.track}>
          <UiIcon name={primaryCta.icon} />
          {primaryCta.label}
        </a>
        <a
          href={secondaryCta.href}
          target={secondaryCta.isExternal ? "_blank" : undefined}
          rel={secondaryCta.isExternal ? "noopener" : undefined}
          class={`${secondaryCta.className} header-cta-secondary`}
          data-track={secondaryCta.track}
        >
          <UiIcon name={secondaryCta.icon} />
          {secondaryCta.label}
        </a>
      </div>

      <button
        id="menu-toggle"
        class="menu-toggle"
        aria-expanded="false"
        aria-controls="mobile-menu"
        aria-label="Apri menu"
      >
        <span class="text-lg" aria-hidden="true">â˜°</span>
      </button>
    </div>
  </div>

  <div id="mobile-menu" class="mobile-menu hidden lg:hidden">
    <div class="site-container py-3">
      <div class="mobile-menu-panel">
        <nav class="mobile-menu-links" aria-label="Menu principale mobile">
          {links.map((link) => {
            const isCurrent = currentPath === link.href || (link.href !== "/" && currentPath.startsWith(link.href));
            return (
              <a href={link.href} aria-current={isCurrent ? "page" : undefined} class={`mobile-menu-link ${isCurrent ? "is-active" : ""}`}>
                {link.label}
              </a>
            );
          })}
        </nav>
        <div class="mobile-menu-cta-grid">
          <a href={primaryCta.href} class="btn btn-primary tap-target" data-track={primaryCta.track}>
            <UiIcon name={primaryCta.icon} />
            {primaryCta.label}
          </a>
          <a href={secondaryCta.href} target="_blank" rel="noopener" class="btn btn-whatsapp tap-target" data-track={secondaryCta.track}>
            <UiIcon name="whatsapp" />
            {secondaryCta.label}
          </a>
          <a href={`tel:${site.phoneHref}`} class="btn btn-secondary tap-target sm:col-span-2" data-track="click_phone">
            <UiIcon name="phone" />
            {site.phoneDisplay}
          </a>
        </div>
      </div>
    </div>
  </div>
</header>

<script is:inline>
  const btn = document.getElementById("menu-toggle");
  const menu = document.getElementById("mobile-menu");
  const header = document.getElementById("site-header");

  const syncHeaderScroll = () => {
    if (!header) return;
    header.classList.toggle("is-scrolled", window.scrollY > 8);
  };

  syncHeaderScroll();
  window.addEventListener("scroll", syncHeaderScroll, { passive: true });
  document.body.classList.remove("mobile-menu-open");

  if (btn && menu) {
    const setOpen = (open) => {
      menu.classList.toggle("hidden", !open);
      btn.setAttribute("aria-expanded", String(open));
      btn.setAttribute("aria-label", open ? "Chiudi menu" : "Apri menu");
      header?.classList.toggle("menu-open", open);
      document.body.classList.toggle("mobile-menu-open", open);
    };

    btn.addEventListener("click", () => {
      const isOpen = !menu.classList.contains("hidden");
      setOpen(!isOpen);
    });

    menu.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => setOpen(false));
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") setOpen(false);
    });
  }
</script>
