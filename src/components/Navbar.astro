---
import { site, getWhatsAppUrl } from "../data/site";
import UiIcon from "./icons/UiIcon.astro";

const links = [
  { href: "/", label: "Home" },
  { href: "/servizi", label: "Servizi" },
  { href: "/chi-siamo", label: "Chi siamo" },
  { href: "/casi-studio", label: "Casi studio" },
  { href: "/certificazioni", label: "Certificazioni" },
  { href: "/customer-care", label: "Customer care" },
  { href: "/contatti", label: "Contatti" },
];
const currentPath = Astro.url.pathname;

const primaryCta = currentPath.startsWith("/customer-care")
  ? { href: "/contatti", label: "Nuovo preventivo", track: "click_nav_lead", icon: "clipboard" as const }
  : { href: "/contatti", label: "Richiedi preventivo", track: "click_nav_lead", icon: "clipboard" as const };

const secondaryCta = currentPath.startsWith("/customer-care")
  ? {
      href: getWhatsAppUrl("Ciao GED Group, sono cliente attivo e ho bisogno di assistenza."),
      label: "WhatsApp assistenza",
      isExternal: true,
      track: "click_whatsapp",
      className: "btn btn-whatsapp",
      icon: "whatsapp" as const,
    }
  : {
      href: getWhatsAppUrl(),
      label: "WhatsApp",
      isExternal: true,
      track: "click_whatsapp",
      className: "btn btn-whatsapp",
      icon: "whatsapp" as const,
    };
---

<header class="sticky top-0 z-40 border-b border-[color:var(--border)] bg-white/90 backdrop-blur-sm">
  <div class="site-container">
    <div class="flex items-center justify-between gap-3 py-3.5">
      <a href="/" class="flex items-center gap-3 rounded-md pr-2">
        <div class="grid h-10 w-10 place-items-center rounded-[var(--radius-md)] bg-[color:var(--accent)] text-sm font-bold text-white shadow-sm">
          G
        </div>
        <div>
          <div class="text-sm font-semibold leading-tight text-slate-900">{site.companyName}</div>
          <div class="text-xs leading-tight text-slate-500">Impresa di pulizie</div>
        </div>
      </a>

      <nav class="hidden items-center gap-1 lg:flex" aria-label="Menu principale desktop">
        {links.map((link) => {
          const isCurrent = currentPath === link.href || (link.href !== "/" && currentPath.startsWith(link.href));
          return (
            <a
              href={link.href}
              aria-current={isCurrent ? "page" : undefined}
              class={`btn nav-item text-sm font-medium ${isCurrent ? "nav-item-active" : "btn-ghost text-slate-700"}`}
            >
              {link.label}
            </a>
          );
        })}
      </nav>

      <div class="hidden items-center gap-2 lg:flex">
        <a href={primaryCta.href} class="btn btn-primary" data-track={primaryCta.track}>
          <UiIcon name={primaryCta.icon} />
          {primaryCta.label}
        </a>
        <a
          href={secondaryCta.href}
          target={secondaryCta.isExternal ? "_blank" : undefined}
          rel={secondaryCta.isExternal ? "noopener" : undefined}
          class={secondaryCta.className}
          data-track={secondaryCta.track}
        >
          <UiIcon name={secondaryCta.icon} />
          {secondaryCta.label}
        </a>
      </div>

      <button
        id="menu-toggle"
        class="grid h-11 w-11 place-items-center rounded-[var(--radius-md)] border border-[color:var(--border)] bg-white text-slate-700 lg:hidden"
        aria-expanded="false"
        aria-controls="mobile-menu"
        aria-label="Apri menu"
      >
        <span class="text-lg">â˜°</span>
      </button>
    </div>
  </div>

  <div id="mobile-menu" class="hidden border-t border-[color:var(--border)] bg-white lg:hidden">
    <div class="site-container py-3">
      <nav class="flex flex-col gap-1.5" aria-label="Menu principale mobile">
        {links.map((link) => {
          const isCurrent = currentPath === link.href || (link.href !== "/" && currentPath.startsWith(link.href));
          return (
            <a
              href={link.href}
              aria-current={isCurrent ? "page" : undefined}
              class={`btn tap-target justify-start px-3 text-sm ${isCurrent ? "nav-item-active" : "btn-ghost text-slate-700"}`}
            >
              {link.label}
            </a>
          );
        })}
      </nav>
      <div class="mt-3 grid grid-cols-2 gap-2">
        <a href={primaryCta.href} class="btn btn-primary tap-target" data-track={primaryCta.track}>
          <UiIcon name={primaryCta.icon} />
          {primaryCta.label}
        </a>
        <a
          href={secondaryCta.href}
          target={secondaryCta.isExternal ? "_blank" : undefined}
          rel={secondaryCta.isExternal ? "noopener" : undefined}
          class="btn btn-whatsapp tap-target"
          data-track={secondaryCta.track}
        >
          <UiIcon name={secondaryCta.icon} />
          {secondaryCta.label}
        </a>
      </div>
    </div>
  </div>
</header>

<script is:inline>
  const btn = document.getElementById("menu-toggle");
  const menu = document.getElementById("mobile-menu");

  if (btn && menu) {
    const setOpen = (open) => {
      menu.classList.toggle("hidden", !open);
      btn.setAttribute("aria-expanded", String(open));
      btn.setAttribute("aria-label", open ? "Chiudi menu" : "Apri menu");
    };

    btn.addEventListener("click", () => {
      const isOpen = !menu.classList.contains("hidden");
      setOpen(!isOpen);
    });

    menu.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => setOpen(false));
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") setOpen(false);
    });
  }
</script>
