---
import { getWhatsAppUrl } from "../data/site";
import UiIcon from "./icons/UiIcon.astro";
---

<div id="floating-contact" class="floating-contact">
  <button
    id="floating-contact-toggle"
    class="floating-contact__toggle"
    type="button"
    aria-expanded="false"
    aria-controls="floating-contact-menu"
    aria-label="Apri azioni contatto"
  >
    <UiIcon name="message-circle" class="floating-contact__toggle-icon" />
    <span>Contatta</span>
  </button>

  <div id="floating-contact-menu" class="floating-contact__menu" hidden>
    <a href={getWhatsAppUrl()} target="_blank" rel="noopener" class="btn btn-whatsapp floating-contact__action" data-track="click_whatsapp">
      <UiIcon name="whatsapp" />
      WhatsApp
    </a>
    <a href="/contatti#lead-form" class="btn btn-secondary floating-contact__action" data-track="click_nav_lead">
      <UiIcon name="clipboard" />
      Vai al form contatti
    </a>
  </div>
</div>

<script is:inline>
  const floatingRoot = document.getElementById("floating-contact");
  const toggle = document.getElementById("floating-contact-toggle");
  const menu = document.getElementById("floating-contact-menu");

  if (floatingRoot && toggle && menu) {
    const closeMenu = () => {
      menu.hidden = true;
      toggle.setAttribute("aria-expanded", "false");
    };

    const openMenu = () => {
      menu.hidden = false;
      toggle.setAttribute("aria-expanded", "true");
    };

    toggle.addEventListener("click", () => {
      const isOpen = toggle.getAttribute("aria-expanded") === "true";
      if (isOpen) closeMenu();
      else openMenu();
    });

    document.addEventListener("click", (event) => {
      if (!floatingRoot.contains(event.target)) closeMenu();
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") closeMenu();
    });

    menu.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => closeMenu());
    });
  }
</script>
